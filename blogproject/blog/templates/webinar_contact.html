{% extends "base.html" %}
{% block content %}
<style>
    .webinar-registrations {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0.5rem;
    }
    .page-header {
        margin-bottom: 0.5rem;
    }
    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1f2937;
        margin-bottom: 0.5rem;
    }
    .page-header p {
        color: #6b7280;
        font-size: 0.95rem;
    }

    .actions {
        margin-bottom: 0.5rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .search-box {
        position: relative;
        flex: 1;
        max-width: 400px;
    }
    .search-input {
        width: 100%;
        padding: 0.75rem 1rem 0.75rem 2.5rem;
        border: 1px solid #e5e7eb;
        border-radius: 0.5rem;
        font-size: 0.95rem;
    }

    .download-btn {
        display: flex;
        align-items: center;
        padding: 0.75rem 1.25rem;
        background-color: #10b981;
        color: white;
        border-radius: 0.5rem;
        cursor: pointer;
        border: none;
        font-size: 0.9rem;
    }

    .delete-btn {
        background: #ef4444;
    }

    .table-container {
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
    }

    table {
        width: 100%;
        border-collapse: collapse;
    }

    th, td {
        padding: 0.8rem;
        border-bottom: 1px solid #e5e7eb;
        font-size: 0.9rem;
    }

    thead {
        background: #f9fafb;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 1rem;
        gap: 0.5rem;
    }

    .pagination-btn {
        padding: 0.4rem 0.8rem;
        border: 1px solid #e5e7eb;
        background: white;
        cursor: pointer;
    }
</style>

<div class="webinar-registrations">
    <div class="page-header">
        <h1>Webinar Registrations</h1>
        <p>View and manage all registrations for the webinar</p>
        <p style="font-size:0.9rem; color:#374151;">
            Total Registrations: <strong id="totalCount">{{ registrations|length }}</strong>
        </p>
        <p style="font-size:0.85rem; color:#6b7280;">
            Selected: <strong id="selectedCount">0</strong>
        </p>
    </div>

    <div class="actions">
        <div class="search-box">
            <input
                type="text"
                class="search-input"
                id="searchInput"
                placeholder="Search..."
                onkeyup="filterTable()"
            >
        </div>

        <div style="display:flex; gap:0.5rem;">
            <button class="download-btn" onclick="downloadCSV()">Download CSV</button>
            <button class="download-btn delete-btn" onclick="deleteSelected()">Delete Selected</button>
        </div>
    </div>

    <div class="table-container">
        <table id="registrationsTable">
            <thead>
                <tr>
                    <th>
                        <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)">
                    </th>
                    <th>No.</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Company</th>
                    <th>Phone</th>
                    <th>Registered On</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for reg in registrations %}
                <tr data-id="{{ reg.id }}">
                    <td><input type="checkbox" class="row-checkbox"></td>
                    <td class="row-number"></td>
                    <td><strong>{{ reg.first_name }} {{ reg.last_name }}</strong></td>
                    <td>{{ reg.email }}</td>
                    <td>{{ reg.company_name|default:"—" }}</td>
                    <td>{{ reg.phone|default:"—" }}</td>
                    <td>{{ reg.created_at|date:"M d, Y H:i" }}</td>
                    <td>
                        <button class="pagination-btn" onclick="deleteSingle({{ reg.id }})">
                            Delete
                        </button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="8" style="text-align:center; padding:2rem;">
                        No registrations yet
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination" id="pagination">
        <button class="pagination-btn" onclick="changePage(-1)" id="prevBtn">Prev</button>
        <span id="pageInfo"></span>
        <button class="pagination-btn" onclick="changePage(1)" id="nextBtn">Next</button>
    </div>
</div>

<script>
let currentPage = 1;
const rowsPerPage = 10;
let allRows = [];
let filteredRows = [];

document.addEventListener('DOMContentLoaded', () => {
    allRows = Array.from(document.querySelectorAll('#tableBody tr'));
    filteredRows = allRows;
    showPage(1);
});

function showPage(page) {
    currentPage = page;
    const start = (page - 1) * rowsPerPage;
    const end = start + rowsPerPage;

    allRows.forEach(r => r.style.display = 'none');
    filteredRows.slice(start, end).forEach(r => r.style.display = '');

    updateRowNumbers();
    updatePagination();
}

function updateRowNumbers() {
    filteredRows.forEach((row, index) => {
        const cell = row.querySelector('.row-number');
        if (cell) cell.textContent = index + 1;
    });
}

function updatePagination() {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    document.getElementById('pageInfo').innerText = `Page ${currentPage} of ${totalPages || 1}`;
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
}

function changePage(dir) {
    const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
    const next = currentPage + dir;
    if (next >= 1 && next <= totalPages) showPage(next);
}

function filterTable() {
    const q = searchInput.value.toLowerCase();
    filteredRows = allRows.filter(row => row.innerText.toLowerCase().includes(q));
    showPage(1);
}

function toggleSelectAll(source) {
    document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = source.checked);
    updateSelectedCount();
}

function updateSelectedCount() {
    document.getElementById('selectedCount').innerText =
        document.querySelectorAll('.row-checkbox:checked').length;
}

document.addEventListener('change', e => {
    if (e.target.classList.contains('row-checkbox')) {
        updateSelectedCount();
    }
});

function deleteSingle(id) {
    if (!confirm("Delete this record?")) return;

    fetch(`/webinar/delete/${id}/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" }
    }).then(() => location.reload());
}

function deleteSelected() {
    const ids = Array.from(document.querySelectorAll('.row-checkbox:checked'))
        .map(cb => cb.closest('tr').dataset.id);

    if (!ids.length) {
        alert("No rows selected");
        return;
    }

    if (!confirm(`Delete ${ids.length} records?`)) return;

    fetch(`/webinar/delete-multiple/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ ids })
    }).then(() => location.reload());
}

function downloadCSV() {
    const selectedRows = Array.from(
        document.querySelectorAll('.row-checkbox:checked')
    ).map(cb => cb.closest('tr'));

    const rowsToExport = selectedRows.length > 0 ? selectedRows : filteredRows;

    if (!rowsToExport.length) {
        alert("No data to export");
        return;
    }

    let csv = "Name,Email,Company,Phone,Registered On\n";

    rowsToExport.forEach(row => {
        const cols = row.querySelectorAll("td");
        if (cols.length > 1) {
            csv += `"${cols[2].innerText.trim()}","${cols[3].innerText.trim()}","${cols[4].innerText.trim()}","${cols[5].innerText.trim()}","${cols[6].innerText.trim()}"\n`;
        }
    });

    const link = document.createElement("a");
    link.href = "data:text/csv;charset=utf-8," + encodeURIComponent(csv);
    link.download = "webinar_registrations.csv";
    link.click();
}
</script>
{% endblock %}
